# 凯利公式

凯利公式、凯利方程、凯利策略（Kelly criterion、Kelly strategy、Kelly bet），是一种根据赌博赢或输的概率，计算出每次下注的资金占所有赌本的最佳比例的公式，由约翰·拉里·凯利于 1956 年在《贝尔系统技术期刊》中发表，可用以计算出每次游戏中应投注的资金比例。历史上丹尼尔·伯努利 1738 年曾提出等价的观点，但伯努利的文章直到 1954 年才首次译成英语, 影响面较窄。

## 陈述

凯利公式的最一般性陈述为，借由寻找能最大化结果对数期望值的资本比例 $f^*$，即可获得长期增长率的最大化。对于只有两种结果(例如猜硬币)的简单赌局：要么输掉所有本金，要么赢得本金乘以特定赔率，公式的一般性陈述为：

$$ f^* = \frac{bp-(1-p)}{b} $$

其中
* $p$ 为获胜率；
* $b$ 为投注可得的赔率（风险报酬比）；
* $f^*$ 为现有资金应进行下次投注的比例；

举例而言，若一赌博有 60% 的获胜率（ $p = 0.6，1-p = 0.4$ ），而赌客在赢得赌局时，可获得一赔一的赔率（ $b = 1$ ）则赌客应在每次机会中下注现有资金的 20%（ $f^* = 0.2$ ），以最大化资金的长期增长率。赔率**如果没有优势**，即 $0 \leq  b \leq \frac{(1-p)}{p}$，公式的结果 $f^* \leq 0$，那么公式**建议别下注**。 如果赔率是负的，即 $b \lt 0$，也就是暗示应该下注到另外一边。

## 证明

**賭局：勝率為 $p$，賠率為 $b$ (壓 1 元贏了可拿回 $1+b$ 元，輸了 1 元全賠光)**

假設這賭局可不斷的重複玩下去，且每次都壓手上全部資金的比例 $f$。我們的工作是去決定這個 $f$ 該選多少，使得在玩過多次賭局後，資金成長最快。

假設 $A_t$ 表示玩到第 $t$ 次賭局後的資金，我們分成下面兩個 CASE 討論：

**CASE 1：若第 $t-1$ 次賭局的結果為贏，則 $A_t = A_{t-1}(1 + bf)　$**

(說明) 因為每次都壓原來資金的 $f$ 比例。換句話說，在時間點 $t - 1$ 時一共壓了 $A_{t-1}f$ 那麼多資金。因為賭局結果為贏，且賠率為 $b$，所以會淨賺$A_{t-1}fb$，再加上原來的資金 $A_{t-1}$，故在時間點 t 的資金變為 

$$ A_t = A_{t-1} + A_{t-1}fb = A_{t-1}(1 + bf) $$

**CASE 2: 若第 $t - 1$ 次賭局的結果為輸，則 $A_t = A_{t-1}(1 - f)$**

(說明) 因為每次都壓原來資金的 $f$ 比例。換句話說，在時間點 $t - 1$ 時一共壓了 $A_{t-1}f$  那麼多資金。因為賭局結果為輸，且所壓的資金是全部輸光，所以一共賠了 $A_{t-1}f$，故在時間點 $t$ 的資金變為 

$$ At = A_{t-1} - A_{t-1}f = A_{t-1}(1 - f) $$

有了上面兩個 CASE 後，我們可以開始計算每一次賭局後的資金變化：

只要下一個時間點贏，就將原來的資金乘上 $(1 + bf)$；只要下一個時間點輸，就將原來的資金乘上 $(1 - f)$。

我們假設總共玩了 $T$ 次。在 $T$ 次的賭局裡，贏了 $W$ 次，輸了 $L$ 次 (也就是 $T = W + L$ )。因此，從一開始 (時間點為 $t = 0$)手上的資金為 $A_0$，到時間點 $T$ 的總資金可以表示如下：

$$ A_T = A_0(1 + bf)^W(1 - f)^L $$

再來要做的工作便是決定 $f$ 多少，使得 $A_T$ 可以最大化。這就完全是微積分求最大值的简单的計算問題。

**问题: 决定 $f$ 使得 $ A_T = A_0(1 + bf)^W(1 - f)^L $ 最大值**

**解:**

Step 1: 将原式子两边取 $log$ 函数, 整理后得

$$ \frac{1}{T} \log(\frac{A_T}{A_0}) = \frac{W}{T}\log(1+bf) + \frac{L}{T}\log(1-f) $$

Step 2: 若 $ T $ 逼近到无穷大(也就是玩无限次), 因为胜率为 $p$, 故 $ \frac{W}{T} $ 会趋近于 p; $ \frac{L}{T} $ 会趋近于 $ 1-p $. 即

$$ \lim_{T \to \infty } \frac{1}{T} \log(\frac{A_T}{A_0}) = p\log(1+bf) + (1-p)\log(1-f) $$

Step 3: 决定 $f$ 使得上式子有最大值(取微分后设为0可得)

$$ p\frac{b}{1+bf} - (1-p)\frac{1}{1-f} = 0 $$

解出 $f$ 得

$$ f = \frac{bp-(1-p)}{b} = \frac{p(1+b)-1}{b} = \frac{期望净利}{赔率} $$

結論：由上面推導可知，每一次賭局所要投入的資金比例為期望淨利除上賠率。注意到當期望淨利為正的時候(分子為正)，變是第一篇所提的有利賭局。只有在有利賭局的時後，才值得下注，而上面的推導告訴你該怎麼下注？

## 劣势

凯利公式原本是为了协助规划电子比特流量设计，后来被引用于赌二十一点上去，麻烦就出在一个简单的事实，二十一点并非商品或交易。赌二十一点时，你可能会输的赌本只限于所放进去的筹码，而可能会赢的利润，也只限于赌注筹码的范围。但商品交易输赢程度是没得准的，会造成资产或输赢有很大的震幅。当赔率变得更有利时，推荐的赌注规模也越来越大，这是很激进的，一但遭遇系统风险黑天鹅是致命的. 而且在实战中赔率 $ b $ 和 胜率 $ p $ 随着品还有个人经验以及时间随时在变, 非常考验个人主观功力. 凯利公式涉及领域和和拓展决策极其丰富和复杂, 但对于普通人最有用一条大数规律是, **优势不大的时候, 数学告诉你下小注**.
